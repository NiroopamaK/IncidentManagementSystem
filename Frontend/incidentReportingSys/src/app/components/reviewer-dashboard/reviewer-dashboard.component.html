<app-top-navbar></app-top-navbar>
<div class="container">
  <div class="content-wrapper">
    <h2 class="section-title">My Assigned Incidents</h2>

    <!-- FILTER -->
    <div class="filter-section" *ngIf="incidents.length > 0">
      <label>Filter by Status:</label>
      <select
        [(ngModel)]="selectedStatus"
        (ngModelChange)="onFilterChange()"
        class="status-filter"
      >
        <option *ngFor="let s of filterStatuses" [value]="s">{{ s }}</option>
      </select>
    </div>

    <!-- INCIDENT CARDS -->
    <div *ngIf="paginatedIncidents.length > 0; else noIncidents">
      <div
        *ngFor="let incident of paginatedIncidents; let i = index"
        class="incident-box"
      >
        <div class="incident-row">
          <h3 class="incident-title">{{ incident.title }}</h3>

          <div class="incident-actions">
            <!-- Editable Status 
            <select
              #statusSelect
              class="status"
              [value]="incident.status"
              (change)="updateStatus(incident, statusSelect.value)"
            >
              <option *ngFor="let s of incidentStatuses" [value]="s">
                {{ s }}
              </option>
            </select>-->
            <select
              class="status"
              [(ngModel)]="incident.status"
              (ngModelChange)="updateStatus(incident, $event)"
            >
              <option *ngFor="let s of incidentStatuses" [ngValue]="s">
                {{ s }}
              </option>
            </select>

            <!-- Expand button -->
            <button
              class="view-details-btn"
              [ngClass]="{ expanded: expandedIncidents[i] }"
              (click)="toggleDetails(i)"
            >
              <span class="arrow">âŒ„</span>
            </button>
          </div>
        </div>

        <!-- DETAILS -->
        <div *ngIf="expandedIncidents[i]" class="incident-details">
          <p><strong>Created By:</strong> {{ incident.createdByName }}</p>
          <p><strong>Description:</strong> {{ incident.description }}</p>

          <!-- COMMENTS -->
          <ul *ngIf="incident.comments.length">
            <li *ngFor="let comment of incident.comments">{{ comment }}</li>
          </ul>
          <p *ngIf="!incident.comments.length">No comments yet.</p>

          <!-- ADD COMMENT -->
          <form
            [formGroup]="incident.commentForm"
            (ngSubmit)="addComment(incident)"
          >
            <input
              type="text"
              formControlName="message"
              placeholder="Add a comment..."
            />
            <button
              type="submit"
              class="submit-btn"
              [disabled]="incident.commentForm.invalid"
            >
              Add Comment
            </button>
          </form>
        </div>
      </div>

      <!-- PAGINATION -->
      <div class="pagination" *ngIf="filteredIncidents.length > 0">
        <button (click)="prevPage()" [disabled]="currentPage === 1">
          Previous
        </button>
        <span>Page {{ currentPage }} of {{ totalPages() }}</span>
        <button (click)="nextPage()" [disabled]="currentPage === totalPages()">
          Next
        </button>
      </div>
    </div>

    <!-- NO INCIDENTS TEMPLATE -->
    <ng-template #noIncidents>
      <p class="no-incidents-text">
        No incidents have been assigned to you yet.
      </p>
    </ng-template>
  </div>
</div>
